#!/usr/bin/env bash
# This script checks and resolves issues related to Nginx configuration

# Check if the "listen 80 default_server;" line is present and correctly configured in the default site configuration file
if ! grep -q "listen 80 default_server;" /etc/nginx/sites-available/default; then
    echo "Error: 'listen 80 default_server;' is missing or misconfigured in /etc/nginx/sites-available/default"
    # Option 1: Reconfigure /etc/nginx/sites-available/default and create symbolic link if needed
    # Option 2: Modify /etc/nginx/sites-enabled/default directly
    # Implement your preferred solution here
fi

# Check if another web server like Apache is active and using port 80
if sudo netstat -tuln | grep -q ":80"; then
    echo "Error: Another web server like Apache is active and using port 80"
    # Stop the Apache service
    sudo service apache2 stop
fi

# Check if Nginx is running with sudo privileges
if ! sudo nginx -t -c /etc/nginx/nginx.conf &> /dev/null; then
    echo "Error: Nginx is not run with sudo privileges"
    # Restart Nginx with sudo privileges
    sudo systemctl restart nginx
fi

# Check if UFW firewall configuration is restricting Nginx from binding to port 80
if sudo ufw status | grep -q "80/tcp"; then
    echo "Error: UFW firewall configuration is restricting Nginx from binding to port 80"
    # Allow incoming traffic on port 80
    sudo ufw allow 80/tcp
fi
